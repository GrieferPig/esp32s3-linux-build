name: Build and Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare Host Environment
      run: bash prepare_host.sh

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push Environment Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ghcr.io/${{ github.repository }}:latest

    - name: Run Full Build in Container
      run: |
        docker run --rm \
          -v $(pwd)/sources:/app/sources \
          -v $(pwd)/toolchain:/app/toolchain \
          -v $(pwd)/build-output:/app/build-output \
          -u root \
          ghcr.io/${{ github.repository }}:latest /bin/bash -c "
            set -e
            chown -R esp32:esp32 /app/build-output /app/sources
            
            # 1. Build dynconfig
            su esp32 -c 'make -C /app/sources/xtensa-dynconfig ORIG=1 CONF_DIR=/app/sources/config-esp32s3 esp32s3.so'
            
            # 2. Build ESP-Hosted (Bootloader, Partition Table, Network Adapter)
            su esp32 -c '
                cd /app/sources/esp-hosted/esp_hosted_ng/esp/esp_driver && \
                [ -d esp-idf ] || git clone --recursive https://github.com/espressif/esp-idf.git -b v5.1 --depth 1 esp-idf && \
                cd esp-idf && \
                sed -i \"/gdbgui/d\" requirements.txt && \
                ./install.sh esp32s3 && \
                . ./export.sh && \
                cd ../network_adapter && \
                idf.py set-target esp32s3 && \
                cp sdkconfig.defaults.esp32s3 sdkconfig && \
                idf.py build
            '

            # 3. Build Buildroot
            cd /app/sources/buildroot
            su esp32 -c '
                make O=/app/build-output esp32s3_defconfig && \
                /app/sources/buildroot/utils/config --file /app/build-output/.config --set-str TOOLCHAIN_EXTERNAL_PATH /app/toolchain/xtensa-esp32s3-linux-uclibcfdpic && \
                /app/sources/buildroot/utils/config --file /app/build-output/.config --set-str TOOLCHAIN_EXTERNAL_PREFIX \"\$(ARCH)-esp32s3-linux-uclibcfdpic\" && \
                /app/sources/buildroot/utils/config --file /app/build-output/.config --set-str TOOLCHAIN_EXTERNAL_CUSTOM_PREFIX \"\$(ARCH)-esp32s3-linux-uclibcfdpic\" && \
                make O=/app/build-output
            '
            
            # 4. Consolidate artifacts
            mkdir -p /app/build-output/release
            cp /app/sources/esp-hosted/esp_hosted_ng/esp/esp_driver/network_adapter/build/bootloader/bootloader.bin /app/build-output/release/
            cp /app/sources/esp-hosted/esp_hosted_ng/esp/esp_driver/network_adapter/build/partition_table/partition-table.bin /app/build-output/release/
            cp /app/sources/esp-hosted/esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin /app/build-output/release/
            cp /app/build-output/images/etc.jffs2 /app/build-output/release/
            cp /app/build-output/images/xipImage /app/build-output/release/
            cp /app/build-output/images/rootfs.cramfs /app/build-output/release/
            cp /app/build-output/images/esp32s3-devkit-c1.dtb /app/build-output/release/
          "

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: build-output/release/*
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        body: |
          Flash offsets:
          - 0x0000 bootloader.bin
          - 0x8000 partition-table.bin
          - 0x10000 network_adapter.bin
          - 0xb0000 etc.jffs2
          - 0x120000 xipImage
          - 0x480000 rootfs.cramfs
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
