name: Build and Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare Host Environment
      run: bash prepare_host.sh

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Environment Image
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: esp32s3-linux

    - name: Run Build Process
      run: bash build.sh

    - name: Prepare Release Artifacts
      run: |
        mkdir -p release_artifacts
        cp sources/esp-hosted/esp_hosted_ng/esp/esp_driver/network_adapter/build/bootloader/bootloader.bin release_artifacts/
        cp sources/esp-hosted/esp_hosted_ng/esp/esp_driver/network_adapter/build/partition_table/partition-table.bin release_artifacts/
        cp sources/esp-hosted/esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin release_artifacts/
        cp build-output/images/etc.jffs2 release_artifacts/
        cp build-output/images/xipImage release_artifacts/
        cp build-output/images/rootfs.cramfs release_artifacts/
        cp build-output/.config release_artifacts/buildroot.config

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: release_artifacts/*
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
