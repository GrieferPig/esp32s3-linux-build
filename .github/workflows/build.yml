name: Build and Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare Host Environment
      run: bash prepare_host.sh

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push Environment Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ghcr.io/${{ github.repository }}:latest

    - name: Run Buildroot in Container
      run: |
        docker run --rm \
          -v $(pwd)/sources:/app/sources \
          -v $(pwd)/toolchain:/app/toolchain \
          -v $(pwd)/build-output:/app/build-output \
          ghcr.io/${{ github.repository }}:latest /bin/bash -c "
            # Build dynconfig .so
            make -C /app/sources/xtensa-dynconfig ORIG=1 CONF_DIR=/app/sources/config-esp32s3 esp32s3.so && \
            # Build Buildroot
            cd /app/sources/buildroot && \
            make O=/app/build-output esp32s3_defconfig && \
            /app/sources/buildroot/utils/config --file /app/build-output/.config --set-str TOOLCHAIN_EXTERNAL_PATH /app/toolchain/xtensa-esp32s3-linux-uclibcfdpic && \
            /app/sources/buildroot/utils/config --file /app/build-output/.config --set-str TOOLCHAIN_EXTERNAL_PREFIX '\$(ARCH)-esp32s3-linux-uclibcfdpic' && \
            /app/sources/buildroot/utils/config --file /app/build-output/.config --set-str TOOLCHAIN_EXTERNAL_CUSTOM_PREFIX '\$(ARCH)-esp32s3-linux-uclibcfdpic' && \
            make O=/app/build-output
          "

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          build-output/images/*
          build-output/.config
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
